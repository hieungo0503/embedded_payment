# Caddyfile for 3diot.vn PayPal Payment System
# This file configures Caddy to serve your website over HTTPS at /embedded-course path
# Uses custom ports to avoid conflicts with Docker Caddy

# Global configuration to avoid standard port conflicts
{
    # Disable automatic HTTP redirects on standard ports (80/443)
    auto_https disable_redirects
    
    # Specify which ports Caddy should NOT try to bind to
    servers {
        protocols h1 h2 h3
    }
}

# HTTPS on custom port 8443 with automatic Let's Encrypt certificates
3diot.vn:8443 {
    # Caddy will automatically obtain Let's Encrypt certificates for this domain:port
    # No conflicts with Docker Caddy on port 443
    
    # Security headers for production
    header {
        # Prevent clickjacking
        X-Frame-Options "DENY"
        
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # Enable XSS protection
        X-XSS-Protection "1; mode=block"
        
        # Strict Transport Security (HSTS)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Content Security Policy for payment security
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.paypal.com https://www.paypalobjects.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://www.paypal.com https://api.emailjs.com; frame-src 'self' https://www.paypal.com; img-src 'self' data: https:;"
        
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Gzip compression for better performance
    encode gzip
    
    # # Logging for monitoring
    # log {
    #     output file /var/log/caddy/3diot.vn.log
    #     format single_field common_log
    # }
    
    # Handle the embedded-course path and its sub-routes
    handle_path /embedded-course* {
        # Reverse proxy to your Node.js application
        reverse_proxy localhost:3000
    }
    
    # Handle PayPal webhook at the embedded-course path
    handle /embedded-course/paypal-payment-success {
        reverse_proxy localhost:3000
    }
    
    handle /embedded-course/paypal-webhook {
        reverse_proxy localhost:3000
    }
    
    handle /embedded-course/health {
        reverse_proxy localhost:3000
    }
    
    # Optional: Handle root domain (redirect to embedded-course or serve other content)
    handle / {
        respond "Welcome to 3DIoT! Visit /embedded-course for our IoT course." 200
    }
    
    # Handle other paths (404 or redirect)
    handle {
        respond "Page not found. Visit /embedded-course for our IoT course." 404
    }
}

# WWW redirect on custom port  
www.3diot.vn:8443 {
    redir https://3diot.vn:8443{uri} permanent
}

# Optional: HTTP redirect on port 8080 (if you want HTTP->HTTPS redirect)
3diot.vn:8080 {
    redir https://3diot.vn:8443{uri} permanent
}

# Optional: Handle other subdomains (if needed)
# api.3diot.vn:8443 {
#     reverse_proxy localhost:3001
# } 